<!DOCTYPE html>
<html>
  <head>
    <title>Rhythm Perception Experiment</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

    <style>
      /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
      body { font-family: 'Noto Sans KR', sans-serif; }
      .jspsych-content { max-width: 800px; margin: auto; }
      .question-box {
        background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
        padding: 30px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: left;
      }
      .question-text { font-size: 1.1em; font-weight: bold; margin-bottom: 20px; display: block; }
      .slider-wrapper { padding: 0 10px; }
      input[type=range] { width: 100%; cursor: pointer; margin: 15px 0; }
      .slider-labels { display: flex; justify-content: space-between; font-size: 0.9em; color: #666; }
      .audio-section { background-color: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 40px; text-align: center; border: 1px solid #eee; }
    </style>
  </head>
  <body></body>
  <script>

    const jsPsych = initJsPsych();

    var timeline = [];

    // [ì¤‘ìš”] DataPipeìš© ëœë¤ ID ë° íŒŒì¼ëª… ìƒì„±
    // ì°¸ì—¬ìë§ˆë‹¤ ë‹¤ë¥¸ íŒŒì¼ëª…ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    // 1. ì‹¤í—˜ ìê·¹
    var audio_stimuli = [
      { stimulus: "stimuli/02_-1.mp3", id: "02_-1" },
      { stimulus: "stimuli/32_shigimsae.mp3", id: "32_shigimsae" }
    ];

    // 2. Preload
    var preload = {
      type: jsPsychPreload,
      audio: audio_stimuli.map(s => s.stimulus)
    };
    timeline.push(preload);

    // 3. ì•ˆë‚´ë¬¸
    var instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div style="text-align: left; background: #fff; padding: 20px; border-radius:8px; border: 1px solid #ddd;">
          <h3>ì‹¤í—˜ ì•ˆë‚´</h3>
          <p>ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
          <p>ê° ì‹œí–‰ë§ˆë‹¤ ë¦¬ë“¬ì„ ììœ ë¡­ê²Œ ë“£ê³  ë‘ ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•´ ì£¼ì„¸ìš”.</p>
        </div>
      `,
      choices: ['ì‹¤í—˜ ì‹œì‘í•˜ê¸°']
    };
    timeline.push(instructions);

    // 4. ë©”ì¸ íŠ¸ë¼ì´ì–¼
    var trial = {
      type: jsPsychSurveyHtmlForm,
      preamble: function() {
        var current_audio = jsPsych.timelineVariable('stimulus');
        return `
          <div class="audio-section">
            <p>ğŸ§ ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“¤ì–´ë³´ì„¸ìš”</p>
            <audio controls controlsList="nodownload" src="${current_audio}" style="width: 100%; max-width: 400px;"></audio>
          </div>
        `;
      },
      html: `
        <div class="question-box">
          <label class="question-text" for="groove">1. ì´ ì¥ë‹¨ì´ ì–¼ë§ˆë‚˜ ëª¸ì„ ì›€ì§ì´ê³  ì‹¶ê²Œ í–ˆë‚˜ìš”?</label>
          <div class="slider-wrapper">
            <input type="range" id="groove" name="groove_rating" min="0" max="100" value="50" step="1">
            <div class="slider-labels"><span>0<br>(ì „í˜€)</span><span>100<br>(ë§¤ìš°)</span></div>
          </div>
        </div>
        <div class="question-box">
          <label class="question-text" for="pleasure">2. ì´ ì¥ë‹¨ì„ ë“¤ìœ¼ë©° ì–¼ë§ˆë‚˜ ì¦ê±°ì›€ì„ ëŠê¼ˆìŠµë‹ˆê¹Œ?</label>
          <div class="slider-wrapper">
            <input type="range" id="pleasure" name="pleasure_rating" min="0" max="100" value="50" step="1">
            <div class="slider-labels"><span>0<br>(ì „í˜€)</span><span>100<br>(ë§¤ìš°)</span></div>
          </div>
        </div>
      `,
      button_label: 'ë‹¤ìŒ',
      data: { stim_id: jsPsych.timelineVariable('id') }
    };

    var test_procedure = {
      timeline: [trial],
      timeline_variables: audio_stimuli,
      randomize_order: true
    };
    timeline.push(test_procedure);

    // [ì¤‘ìš”] 5. DataPipe ì €ì¥ ë‹¨ê³„
    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "9h8uHWnmjGTc", // ì‚¬ìš©ìë¶„ì˜ ì‹¤í—˜ ID
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    // 6. ì¢…ë£Œ í™”ë©´ (ì €ì¥ì´ ì™„ë£Œëœ í›„ ë³´ì—¬ì§)
    var end_screen = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h3>ì‹¤í—˜ ì¢…ë£Œ</h3>
        <p>ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <p>ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
      `,
      choices: ['ì°½ ë‹«ê¸°']
    };
    timeline.push(end_screen);

    jsPsych.run(timeline);

  </script>
</html>
