<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groove & Rhythm Perception Experiment (A)</title>
    
    <!-- jsPsych 라이브러리 및 플러그인 로드 (unpkg 사용) -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    
    <!-- [추가됨] DataPipe 플러그인 -->
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    
    <!-- jsPsych 스타일시트 -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* 전체 페이지 스타일 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #333;
        }
        .jspsych-content {
            max-width: 1000px;
            margin: auto;
            padding-bottom: 50px;
        }

        /* 질문 박스 디자인 */
        .question-box {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: left;
        }

        .question-text {
            font-size: 1.1em;
            font-weight: bold;
            color: #222;
            margin-bottom: 20px;
            display: block;
        }

        .question-label {
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        /* --- PDF Viewer & Consent Styles (Updated) --- */
        .pdf-box {
            width: 100%;
            height: 60vh; 
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: auto; /* 스크롤 가능하게 */
            margin: 12px 0 8px;
        }
        .pdf-box iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .consent-text {
            font-size: 13px;
            margin-bottom: 8px;
            line-height: 1.6;
            color: #333;
        }
        .consent-section-title {
            font-weight: 600;
            margin: 16px 0 4px;
            font-size: 14px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        .consent-input-row {
            margin: 6px 0;
            font-size: 13px;
        }
        .consent-input-row label {
            display: inline-block;
            min-width: 190px;
            font-weight: bold;
        }
        .consent-input-row input[type="text"] {
            width: 60%;
            max-width: 360px;
            padding: 4px 6px;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        /* 반응형 처리 */
        @media (max-width: 600px) {
            .consent-input-row label {
                display: block;
                margin-bottom: 2px;
            }
            .consent-input-row input[type="text"] {
                width: 95%;
                max-width: 100%;
            }
        }

        /* --- Page 2: Eligibility Check Styles --- */
        .jspsych-survey-multi-choice-question {
            text-align: center;
            margin-top: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .jspsych-survey-multi-choice-question:last-child {
            border-bottom: none;
        }

        .jspsych-survey-multi-choice-text {
            text-align: left;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .jspsych-survey-multi-choice-option {
            display: inline-flex !important; 
            align-items: center;
            justify-content: center;
            margin: 0 40px !important;
        }
        
        .jspsych-survey-multi-choice-option input {
            margin-right: 8px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .jspsych-survey-multi-choice-option label {
            cursor: pointer;
            font-size: 1.05em;
        }

        /* --- Custom Likert Style (Page 4) --- */
        .likert-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: 10px;
            width: 100%;
        }
        .likert-label-side {
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
            white-space: nowrap; 
            margin-bottom: 5px; 
            width: 140px; 
            flex-shrink: 0; 
            text-align: center; 
        }
        .likert-options-group {
            display: flex;
            justify-content: space-between;
            flex-grow: 1; 
            margin: 0 10px;
        }
        .likert-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 100%; 
        }
        .likert-num {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .likert-option input[type="radio"] {
            margin: 0;
            width: 20px; 
            height: 20px;
            cursor: pointer;
        }

        /* --- Slider Style (Trials) --- */
        .slider-wrapper {
            padding: 0 40px; 
            margin-bottom: 30px; 
            position: relative; 
        }
        input[type=range] {
            width: 100%;
            cursor: pointer;
            margin: 15px 0;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            display: block;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4a90e2; 
            cursor: pointer;
        }
        .slider-labels-container {
            position: relative;
            width: 100%;
            height: 40px; 
            margin-top: 5px;
        }
        .slider-label-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            top: 0;
            white-space: nowrap; 
            text-align: center;
        }
        .slider-label-left {
            left: 0;
            transform: translateX(-50%);
        }
        .slider-label-right {
            right: 0;
            transform: translateX(50%);
        }
        .slider-num-bold {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        /* 오디오 플레이어 영역 */
        .audio-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #ddd;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .progress-text {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .small-input { width: 80px; padding: 5px; }
        select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; width: 100%; box-sizing: border-box;}
    </style>
</head>
<body>
    <div id="jspsych-target"></div>

<script>
    // 1. jsPsych 초기화 (상단 progress bar 활성화)
    const jsPsych = initJsPsych({
        show_progress_bar: true
    });

    // [중요] DataPipe용 랜덤 ID 생성
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `expA_${subject_id}.csv`;
    
    // 데이터에 subject_id 추가 (모든 행에 기록됨)
    jsPsych.data.addProperties({
        subject_id: subject_id
    });

    // 2. 타임라인 생성
    var timeline = [];

    // --- 본 실험 자극 목록 (Experiment A) ---
    var main_stimuli = [
        { stimulus: "stimuli/original/01_3_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/04_66_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/07_44_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/10_29_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/13_-1_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/16_-1_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/19_-1_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/22_26_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/25_-1_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/28_39_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/31_51_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/34_48_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/37_54_ori.mp3", type: "original" },
        { stimulus: "stimuli/original/40_67_ori.mp3", type: "original" },
        { stimulus: "stimuli/quantized/03_1_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/06_-1_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/09_19_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/12_-1_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/15_-1_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/18_65_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/21_23_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/24_35_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/27_43_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/30_49_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/33_41_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/36_45_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/quantized/39_60_quantized_velocity82.mp3", type: "quantized" },
        { stimulus: "stimuli/shigimsae/1_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/26_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/33_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/3_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/43_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/48_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/53_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/59_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/shigimsae/65_shigimsae.mp3", type: "shigimsae" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_01_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_04_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_07_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_10_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_13_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_16_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_19_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_22_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_25_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_28_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_31_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_34_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_37_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_40_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_43_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_46_80bpm.mp3", type: "drum" },
        { stimulus: "stimuli/drum_stimuli/jangdan_drum_49_80bpm.mp3", type: "drum" }
    ];

    // 연습 파일 제거하고 본 실험 파일만 로드
    var all_audio = main_stimuli.map(a => a.stimulus);

    // 3. Preload
    var preload = {
        type: jsPsychPreload,
        audio: all_audio,
        message: '실험 데이터를 로딩 중입니다. 잠시만 기다려주세요...',
        show_detailed_errors: true,
        continue_after_error: true
    };
    timeline.push(preload);

    // ==========================================
    // [추가] 동의서 및 안내 (Consent & Intro)
    // ==========================================

    // 1-0. 시작 안내 화면
    var intro_screen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="question-box" style="text-align:center;">
                <h1 class="main-title">리듬 및 그루브 지각 실험 안내</h1>
                <div style="text-align:left; margin-top:16px; line-height:1.7;">
                    <p>안녕하세요! 실험에 관심 가져 주셔서 감사합니다. 이 실험에서는 다양한 리듬을 듣고, 각 리듬에 대한 느낌과 지각을 평가하게 됩니다.</p>
                    <p style="margin-top:10px;">본 실험에 참여하시기 위해서는, 다음 두 가지 동의서에 대한 내용을 읽고 동의 여부를 선택해 주셔야 합니다.</p>
                    <ul style="line-height:1.7;">
                        <li><strong>① 인간대상 연구피험자 동의서</strong></li>
                        <li><strong>② (사례비 지급 등)을 위한 개인정보 수집 및 활용 동의서</strong></li>
                    </ul>
                    <p style="margin-top:8px;">
                        두 동의서 모두에 <strong>동의</strong>하셔야만 본 행동실험에 참여하실 수 있으며,<br>
                        동의하지 않으시는 경우 실험이 즉시 종료됩니다.
                    </p>
                    <p style="margin-top:8px;">
                        다음 버튼을 누르시면, 먼저 ① 인간대상 연구피험자 동의서(PDF)를 확인하신 뒤<br>
                        동의 여부 및 서명을 입력하는 화면으로 이동합니다.
                    </p>
                </div>
            </div>
        `,
        choices: ["다음으로 (동의서 확인 시작)"]
    };
    timeline.push(intro_screen);

    // 1-1. 동의서 1: 인간대상 연구피험자 동의서
    var consent_human = {
        type: jsPsychSurveyHtmlForm,
        preamble: `
            <div class="question-box">
                <h1 class="main-title" style="text-align:center;">인간대상연구 피험자 동의서</h1>
                <p class="consent-text">
                    먼저, 아래의 <strong>인간대상 연구피험자 동의서 전문(PDF 파일)</strong>을 스크롤하여 끝까지 읽어주세요.
                </p>
                <div class="pdf-box">
                    <iframe src="documents/experiment_consent.pdf"></iframe>
                </div>
                <p class="consent-text" style="font-size:12px; color:#666; text-align:center;">
                    ※ 모바일에서 PDF가 한 페이지만 보이거나 스크롤이 되지 않을 경우,
                    <a href="documents/experiment_consent.pdf" target="_blank">여기를 눌러 새 탭에서 전체 동의서를 확인</a>해 주세요.
                </p>
                <p class="consent-text">
                    아래 문항들은 동의서 전문에서 <strong>피험자의 동의가 필요한 항목</strong>을 발췌한 것입니다.<br>
                    각 항목을 읽고 현재 본인의 의견에 해당하는 선택지를 골라 주세요. 
                    본 연구는 온라인으로 진행되므로, 응답을 제출하시면 본인은 전자적 방식(e-consent)으로 연구 참여 및 각 동의 항목에 동의하며, 
                    이에 따라 연구자가 본 동의서의 동의 항목 및 서명란을 본인을 대신하여 기재하는 것에 동의한 것으로 간주됩니다.
                </p>
            </div>
        `,
        html: `
            <div class="question-box">
                <!-- 1) 개인정보 수집 동의 -->
                <div class="consent-section-title">[개인정보 수집에 대한 사항 동의]</div>
                <p class="consent-text">본인은 개인정보 수집에 대한 내용을 확인하였으며, 본 연구에서 개인정보 수집에 대하여</p>
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="human_main_collect" value="동의합니다" required>
                    ▶ 동의합니다.
                </label>
                <label style="display:block;">
                    <input type="radio" name="human_main_collect" value="동의하지 않습니다">
                    ▶ 동의하지 않습니다.
                </label>

                <!-- 2) 개인정보 제공 범위 -->
                <div class="consent-section-title">[개인정보의 제공에 관한 사항]</div>
                <p class="consent-text">
                    (타연구자에게 개인정보 제공이 있을 시) 본 연구에서 참여함으로써 수집되는 개인정보는 연주 MIDI 데이터, 실험 자극에 대한 설문 응답 자료, 피험자에 대한 설문자료(배경, 성향 등), 인터뷰 자료, 나이, 생년월일, 성별이며, 해당 정보는 귀하의 동의에 따라 보존 기간내 2차적 사용을 위해 제공될 수 있습니다. 연구자는 타연구자에게 개인정보제공을 제공하는 경우에는 KAIST 생명윤리심의위원회에 개인정보제공에 관하여 별도 심의를 받아야 합니다.
                </p>
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="human_provide_scope" value="유사한 연구 범위 안에서만 제공 동의" required>
                    ▶ 유사한 연구 범위 안에서만 제공하는 것에 동의합니다.
                </label>
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="human_provide_scope" value="포괄적 연구 목적으로 제공 동의">
                    ▶ 포괄적 연구 목적으로 제공하는 것에 동의합니다.
                </label>
                <label style="display:block;">
                    <input type="radio" name="human_provide_scope" value="제공에 동의하지 않음">
                    ▶ 동의하지 않습니다.
                </label>

                <!-- 3) 개인식별정보 포함 여부 -->
                <div class="consent-section-title">[개인식별정보 포함 여부에 대한 동의]</div>
                <p class="consent-text">
                    귀하가 개인정보제공에 대하여 동의시, 해당 정보는 익명화하여 제3자에게 제공됩니다. 다만, 귀하가 개인식별정보를 포함하는 것에 동의한 경우에는 예외로 합니다.
                </p>
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="human_identifiable" value="개인식별정보 포함 동의" required>
                    ▶ 개인식별정보를 포함하는 것에 동의합니다.
                </label>
                <label style="display:block;">
                    <input type="radio" name="human_identifiable" value="개인식별정보 포함 동의하지 않음">
                    ▶ 동의하지 않습니다.
                </label>

                <!-- 4) 새로운 정보 통보 여부 -->
                <div class="consent-section-title">[연구 관련 새로운 정보 통보 여부]</div>
                <p class="consent-text">
                    본 연구진행 중 본인에게 영향을 줄 수도 있는 새로운 정보를 연구자가 획득 시 그 내용을 통보 받을 수 있습니다.
                </p>
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="human_notify" value="통보를 원함" required>
                    ▶ 통보를 원합니다.
                </label>
                <label style="display:block;">
                    <input type="radio" name="human_notify" value="통보를 원치 않음">
                    ▶ 통보를 원치 않습니다.
                </label>

                <!-- 5) 서명 및 기본 정보 입력 -->
                <div class="consent-section-title" style="margin-top:20px;">[본인 확인 및 서명]</div>
                <p class="consent-text">
                    본인은 이 동의서를 읽고 이해하였으며 모든 질문에 대한 답변을 들었습니다. 이에 본인은 자발적으로 본 연구에 참여함을 서명으로 확인합니다.
                </p>
                <p class="consent-text">
                    또한, 본인은 <br>
                    1. 본인과 연구자 및 KAIST 사이에 본인의 연구 참여결정에 영향을 줄 수 있는 어떠한 관계도 없고, <br>
                    2. 요양원 같은 수용 시설에 거주하거나, 인지 기능에 문제가 있지 아니하며, <br>
                    3. 만약, 위에 열거한 1, 2의 상황에 해당되는 경우 생명윤리심의위원회 간사의 입회하에 본 동의서에 대한 설명을 듣고 아래 서명을 하였음을 확인합니다.
                </p>

                <div class="consent-input-row">
                    <label>주소 (동까지만 쓰셔도 됩니다) :</label>
                    <input type="text" name="human_addr" required>
                </div>
                <div class="consent-input-row">
                    <label>연락처 :</label>
                    <input type="text" name="human_phone" required>
                </div>
                <div class="consent-input-row">
                    <label>성명 :</label>
                    <input type="text" name="human_name" required>
                </div>
                <div class="consent-input-row">
                    <label>서명 또는 인 :</label>
                    <input type="text" name="human_sign" required>
                </div>
                <p class="consent-text" style="font-size:12px; margin-top:2px; color:#666;">
                    *피험자가 직접 서명할 수 없는 온라인 실험이므로, (서명 또는 인)란 오른쪽에 본인 이름을 타이핑할 시 연구자가 대리 서명하는 것에 동의한 것으로 간주합니다.
                </p>
                <div class="consent-input-row">
                    <label>동의일자 :</label>
                    <input type="text" name="human_date" placeholder="예: 20251203" required>
                </div>
            </div>
        `,
        button_label: "다음 (사례비 동의서로 이동)",
        on_finish: function(data){
            var resp = data.response;
            
            // 필수 동의 항목 체크
            if(resp.human_main_collect.includes("동의하지")) {
                jsPsych.endExperiment("필수 동의 항목에 동의하지 않으셔서, 행동실험에 참여하실 수 없습니다.\n참여 의사를 검토해 주셔서 감사합니다.");
            }
        }
    };
    timeline.push(consent_human);

    // 1-2. 동의서 2: 개인정보 수집 이용 동의서 (사례비)
    var consent_payment = {
        type: jsPsychSurveyHtmlForm,
        preamble: `
            <div class="question-box">
                <h1 class="main-title" style="text-align:center;">(사례비 지급 등)을 위한 개인정보에 대한 수집 및 활용에 대한 동의서</h1>
                <p class="consent-text">
                    다음은 행동실험 참여에 따른 사례비 지급을 위해 필요한 
                    <strong>개인정보 수집 및 활용 동의서</strong>입니다.<br>
                    아래의 동의서 전문(PDF 파일)을 스크롤하여 끝까지 읽어주세요.
                </p>
                <div class="pdf-box">
                    <iframe src="documents/personal_info_consent.pdf"></iframe>
                </div>
                <p class="consent-text">
                    아래는 동의서 중 <strong>핵심 정보</strong>를 요약한 것입니다.
                    본 연구는 온라인으로 진행되므로, 응답을 제출하시면 본인은 전자적 방식(e-consent)으로 연구 참여 및 각 동의 항목에 동의하며, 
                    이에 따라 연구자가 본 동의서의 동의 항목 및 서명란을 본인을 대신하여 기재하는 것에 동의한 것으로 간주됩니다.
                </p>
                <ul class="consent-text" style="list-style-position: inside;">
                    <li>사례비 : <strong>10,000원 (실험 종료 후 3주 이내 지급)</strong></li>
                </ul>
                <p class="consent-text">
                    사례비 지급을 위해 수집되는 개인정보는 다음과 같습니다.<br>
                    성명, 주민등록번호, 연락처, 계좌번호(은행명 포함), 주소
                </p>
                <p class="consent-text">
                    <strong>▣ 미동의시 불이익 내용 :</strong> 실험에 참여하실 수 없으며, 연구 참여에 따른 사례비를 지급을 받을 수 없습니다.
                </p>
            </div>
        `,
        html: `
            <div class="question-box">
                <div class="consent-section-title">[사례비 지급을 위한 개인정보 입력]</div>

                <div class="consent-input-row">
                    <label>성명 :</label>
                    <input type="text" name="pay_name" required>
                </div>
                <div class="consent-input-row">
                    <label>주민등록번호 :</label>
                    <input type="text" name="pay_rrn" required>
                </div>
                
                <div class="consent-input-row">
                    <label>연락처 :</label>
                    <input type="text" name="pay_phone" required>
                </div>
                <div class="consent-input-row">
                    <label>은행명, 계좌번호 :</label>
                    <input type="text" name="pay_bank_account" required>
                </div>
                <div class="consent-input-row">
                    <label>주소 (동까지만 쓰셔도 됩니다) :</label>
                    <input type="text" name="pay_addr" required>
                </div>

                <div class="consent-section-title" style="margin-top:14px;">[개인정보 수집 및 활용에 대한 동의]</div>
                <p class="consent-text">
                    본인은 위와 같이 본인의 개인정보에 대한 수집 및 활용에 대한 내용을 확인하였으며,
                    개인정보 수집 및 활용에 대하여
                </p>
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="payment_main_consent" value="동의합니다" required>
                    ▶ 동의합니다.
                </label>
                <label style="display:block;">
                    <input type="radio" name="payment_main_consent" value="동의하지 않습니다">
                    ▶ 동의하지 않습니다. (실험 참여 불가)
                </label>

                <div class="consent-section-title" style="margin-top:14px;">[동의일자 및 서명]</div>
                <div class="consent-input-row">
                    <label>동의일자 (20 . . . ) :</label>
                    <input type="text" name="pay_date" placeholder="예: 20251203" required>
                </div>
                <div class="consent-input-row">
                    <label>피험자(동의자) 성명 :</label>
                    <input type="text" name="pay_sign_name" required>
                </div>
                <div class="consent-input-row">
                    <label>서명 :</label>
                    <input type="text" name="pay_sign" required>
                </div>
                <p class="consent-text" style="font-size:12px; margin-top:2px; color:#666;">
                    *피험자가 직접 서명할 수 없는 온라인 실험이므로, (서명)란 오른쪽에 본인 이름을 타이핑할 시
                    연구자가 대리 서명하는 것에 동의한 것으로 간주합니다.
                </p>
            </div>
        `,
        button_label: "다음 (기초 정보 입력)",
        on_finish: function(data){
            var resp = data.response;
            if(resp.payment_main_consent.startsWith("동의하지")){
                jsPsych.endExperiment("사례비 지급을 위한 개인정보 수집·활용에 동의하지 않으셔서, 본 온라인 실험에 참여하실 수 없습니다.\n참여 의사를 검토해 주셔서 감사합니다.");
            }
        }
    };
    timeline.push(consent_payment);


    // --- Page 1: 기본 인적사항 ---
    var page_1_demographics = {
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="question-box" style="text-align:center;"><h3>기본 인적사항</h3><p>아래 정보를 입력해주세요.</p></div>',
        html: `
            <div class="question-box">
                <label class="question-label">이름</label>
                <input type="text" name="name" required style="margin-bottom: 15px; width: 100%; box-sizing: border-box;"><br>
                
                <label class="question-label">만 나이</label>
                <input type="number" name="age" class="small-input" required style="margin-bottom: 15px;"> 세<br>
                
                <label class="question-label">생년월일 (예: 1995.02.22)</label>
                <input type="text" name="dob" placeholder="YYYY.MM.DD" required style="margin-bottom: 15px; width: 100%; box-sizing: border-box;"><br>
                
                <label class="question-label">성별</label>
                <select name="gender" required style="width: 100%;">
                    <option value="">선택하세요</option>
                    <option value="male">남성</option>
                    <option value="female">여성</option>
                </select>
            </div>
        `,
        button_label: '다음'
    };
    timeline.push(page_1_demographics);

    // --- Page 2: 연구 참여자 적격성 검증표 ---
    var page_2_eligibility = {
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="question-box" style="text-align:center;"><h3>연구 참여자 적격성 검증표</h3></div>',
        html: `
            <div class="question-box">
                <p class="question-label">1. 만 20세 이상 64세 이하입니까?</p>
                <label><input type="radio" name="eligibility_age" value="yes" required> 예</label>
                <label><input type="radio" name="eligibility_age" value="no" style="margin-left: 20px;"> 아니오</label>
                <br><br>

                <p class="question-label">2. 청력 때문에 일상 생활에 장애를 겪습니까?</p>
                <label><input type="radio" name="eligibility_hearing" value="yes" required> 예</label>
                <label><input type="radio" name="eligibility_hearing" value="no" style="margin-left: 20px;"> 아니오</label>
                <br><br>

                <p class="question-label">3. 손 움직임의 불편함 때문에 일상 생활에 장애를 겪습니까?</p>
                <label><input type="radio" name="eligibility_hand" value="yes" required> 예</label>
                <label><input type="radio" name="eligibility_hand" value="no" style="margin-left: 20px;"> 아니오</label>
                <br><br>

                <p class="question-label">4. 과거 또는 현재 신경/정신 관련 질환을 겪은 적이 있습니까?</p>
                <label><input type="radio" name="eligibility_neuro" value="yes" required> 예</label>
                <label><input type="radio" name="eligibility_neuro" value="no" style="margin-left: 20px;"> 아니오</label>
                <br><br>

                <p class="question-label">5. 실험 참여 동의서에 서명하였습니까?<br><span style="font-weight:normal; font-size:0.9em;">(연구 시작 전에 반드시 선행되어야 합니다!)</span></p>
                <label><input type="radio" name="consent" value="yes" required> 예 (동의합니다)</label>
                <label><input type="radio" name="consent" value="no" style="margin-left: 20px;"> 아니오</label>
            </div>
        `,
        button_label: '다음'
    };
    timeline.push(page_2_eligibility);

    // --- Page 3: 음악 배경 관련 설문 (수정됨) ---
    var page_3_music_bg = {
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="question-box" style="text-align:center;"><h3>음악 배경 관련 설문</h3></div>',
        html: `
            <div class="question-box">
                <p class="question-label">1. 귀하의 음악 전공 여부를 선택해주세요.</p>
                <div style="margin-left: 5px;">
                    <label style="display:block; margin-bottom:5px;">
                        <input type="radio" name="music_major" value="none" required> 음악 전공이 아님
                    </label>
                    <label style="display:block; margin-bottom:5px;">
                        <input type="radio" name="music_major" value="gugak"> 국악 전공
                    </label>
                    <label style="display:block; margin-bottom:5px;">
                        <input type="radio" name="music_major" value="classic"> 클래식 전공
                    </label>
                    <label style="display:block; margin-bottom:15px;">
                        <input type="radio" name="music_major" value="applied"> 실용음악 전공
                    </label>
                </div>

                <p class="question-label">2. 현재 다룰 수 있는 악기(성악/보컬/소리 포함)는 무엇이 있나요? (전부 답변)</p>
                <p style="font-size: 0.9em; color: #2c3e50; margin-top:-5px; margin-bottom:8px; background-color: #f1f8ff; padding: 5px; border-radius: 4px;">
                    ※ <b>가장 주되게 다루는 악기</b>를 <b>맨 처음</b>에 적어주세요.
                </p>
                <input type="text" name="instruments" style="width: 100%;" placeholder="예: 피아노, 기타, 보컬 등 (주 악기부터 작성)" required>
                <br><br>

                <p class="question-label">3. 지금까지 악기(성악/보컬/소리 포함)를 전문적으로 배우거나 훈련받은 기간은 총 몇 년인가요?</p>
                <p style="font-size: 0.9em; color: gray; margin-top:-5px;">(전문적 훈련의 기준: 예술 중고 또는 대학 전공 과정, 학원, 레슨 포함)</p>
                <input type="number" name="training_years" class="small-input" required> 년
            </div>
        `,
        button_label: '다음'
    };

    timeline.push(page_3_music_bg);

    // --- Page 4: 국악 및 그루브 인식 ---
    function createLikertHTML(questionText, name, leftLabel, rightLabel) {
        let optionsHTML = '';
        for (let i = 1; i <= 7; i++) {
            optionsHTML += `
                <div class="likert-option">
                    <span class="likert-num">${i}</span>
                    <input type="radio" name="${name}" value="${i}" required>
                </div>
            `;
        }
        return `
            <div class="question-box">
                <label class="question-text">${questionText}</label>
                <div class="likert-container">
                    <div class="likert-label-side">${leftLabel}</div>
                    <div class="likert-options-group">
                        ${optionsHTML}
                    </div>
                    <div class="likert-label-side">${rightLabel}</div>
                </div>
            </div>
        `;
    }

    var page_4_groove_survey = {
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="question-box" style="text-align:center;"><h3>음악적 선호도 조사</h3></div>',
        html: `
            ${createLikertHTML("1. 국악(한국 전통 음악)에 대해서 얼마나 친숙한가요?", "gugak_familiarity", "전혀 친숙하지 않음", "매우 친숙함")}
            ${createLikertHTML("2. 평소 국악을 얼마나 자주 듣나요?", "gugak_freq", "전혀 안 들음", "매우 자주 들음")}
            ${createLikertHTML("3. 국악을 얼마나 좋아하나요?", "gugak_like", "전혀 좋아하지 않음", "매우 좋아함")}
            ${createLikertHTML("4. 평소 그루브 기반 음악을 얼마나 자주 듣나요?<br><span style='font-size:0.8em; font-weight:normal;'>(재즈, 펑크, 소울, 힙합, EDM, 레게, 알앤비 등)</span>", "groove_freq", "전혀 안 들음", "매우 자주 들음")}
            ${createLikertHTML("5. 그루브 기반 음악을 얼마나 좋아하나요?", "groove_like", "전혀 좋아하지 않음", "매우 좋아함")}
        `,
        button_label: '다음'
    };
    timeline.push(page_4_groove_survey);

    var page_4_groove_def = {
        type: jsPsychSurveyHtmlForm,
        html: `
            <div class="question-box">
                <label class="question-text">본인이 생각하는 ‘그루브(Groove)’의 정의를 자유롭게 서술해주세요.</label>
                <textarea name="groove_definition" rows="10" required></textarea>
            </div>
        `,
        button_label: '다음'
    };
    timeline.push(page_4_groove_def);


    // --- Page 5: 실험 시작 안내문 (연습 관련 문구 제거됨) ---
    var page_5_instruction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="question-box">
                <h2>실험 시작 안내</h2>
                <div class="instruction-text" style="font-size: 1.1em;">
                    <p>지금부터 청취 실험을 시작합니다.</p>
                    <p style="color: #d9534f; font-weight: bold;">조용한 장소에서 이어폰이나 헤드폰을 착용해주세요!!</p>
                    <br>
                    <p><b>실험 방법:</b></p>
                    <p>1. 각 화면에서 <b>재생 버튼(▶)</b>을 눌러 음악을 들어주세요.</p>
                    <p>2. 음악은 원하는 만큼 반복해서 들을 수 있습니다.</p>
                    <p>3. 음악을 들으며 아래 5가지 질문에 대해 슬라이더를 움직여 응답해 주세요.</p>
                    <br>
                    <p>준비가 되셨다면 시작 버튼을 눌러주세요.</p>
                </div>
            </div>
        `,
        choices: ['실험 시작하기']
    };
    timeline.push(page_5_instruction);

    // --- 시행(Trial) 생성 함수 ---
    var create_slider_trial = function(timeline_vars) {
        return {
            type: jsPsychSurveyHtmlForm,
            preamble: function() {
                var current_audio = jsPsych.timelineVariable('stimulus');
                
                // 진행 상황 계산 (task: 'rating'으로 기록된 데이터 개수 + 1)
                var completed_trials = jsPsych.data.get().filter({task: 'rating'}).count();
                var total_trials = main_stimuli.length;
                var current_trial_num = completed_trials + 1;

                return `
                    <div class="progress-text">진행률: ${current_trial_num} / ${total_trials}</div>
                    <div class="audio-section">
                        <p style="margin-bottom:10px; font-weight:bold; color:#555;">🎧 아래 재생 버튼을 눌러 리듬을 들어보세요</p>
                        <audio controls controlsList="nodownload" src="${current_audio}" style="width: 100%; max-width: 400px;"></audio>
                    </div>
                `;
            },
            html: `
                <!-- 1. 움직임 욕구 (구 4번) -->
                <div class="question-box">
                    <label class="question-text">1. 이 리듬/장단이 얼마나 몸을 움직이고 싶게 했나요?</label>
                    <div class="slider-wrapper">
                        <input type="range" name="move_desire" min="0" max="100" value="50" step="1">
                        <div class="slider-labels-container">
                            <div class="slider-label-item slider-label-left">
                                <span class="slider-num-bold">0</span>
                                <span>전혀 그렇지 않음</span> 
                            </div>
                            <div class="slider-label-item slider-label-right">
                                <span class="slider-num-bold">100</span>
                                <span>매우 그러함</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 즐거움 (구 5번) -->
                <div class="question-box">
                    <label class="question-text">2. 이 리듬/장단을 들으며 얼마나 즐거움을 느꼈습니까?</label>
                    <div class="slider-wrapper">
                        <input type="range" name="enjoyment" min="0" max="100" value="50" step="1">
                        <div class="slider-labels-container">
                            <div class="slider-label-item slider-label-left">
                                <span class="slider-num-bold">0</span>
                                <span>전혀 즐겁지 않음</span>
                            </div>
                            <div class="slider-label-item slider-label-right">
                                <span class="slider-num-bold">100</span>
                                <span>매우 즐거움</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 복잡성 (구 1번) -->
                <div class="question-box">
                    <label class="question-text">3. 이 리듬/장단이 얼마나 복잡하게 느껴졌나요?</label>
                    <div class="slider-wrapper">
                        <input type="range" name="complexity" min="0" max="100" value="50" step="1">
                        <div class="slider-labels-container">
                            <div class="slider-label-item slider-label-left">
                                <span class="slider-num-bold">0</span>
                                <span>매우 단순함</span>
                            </div>
                            <div class="slider-label-item slider-label-right">
                                <span class="slider-num-bold">100</span>
                                <span>매우 복잡함</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. 예측 가능성 (구 2번) -->
                <div class="question-box">
                    <label class="question-text">4. 연주되는 타이밍을 얼마나 예측할 수 있었나요?</label>
                    <div class="slider-wrapper">
                        <input type="range" name="predictability" min="0" max="100" value="50" step="1">
                        <div class="slider-labels-container">
                            <div class="slider-label-item slider-label-left">
                                <span class="slider-num-bold">0</span>
                                <span>전혀 예측 불가</span>
                            </div>
                            <div class="slider-label-item slider-label-right">
                                <span class="slider-num-bold">100</span>
                                <span>매우 쉽게 예측</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. 움직임 용이성 (구 3번) -->
                <div class="question-box">
                    <label class="question-text">5. 이 리듬/장단에 맞춰 몸을 움직이는 것이 얼마나 쉬웠나요?</label>
                    <div class="slider-wrapper">
                        <input type="range" name="move_ease" min="0" max="100" value="50" step="1">
                        <div class="slider-labels-container">
                            <div class="slider-label-item slider-label-left">
                                <span class="slider-num-bold">0</span>
                                <span>매우 어려움</span>
                            </div>
                            <div class="slider-label-item slider-label-right">
                                <span class="slider-num-bold">100</span>
                                <span>매우 쉬움</span>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            button_label: '다음',
            data: {
                task: 'rating',
                stim_type: jsPsych.timelineVariable('type'),
                stim_file: jsPsych.timelineVariable('stimulus')
            },
            on_load: function() {
                window.scrollTo(0,0);
            }
        };
    };

    // --- 본 실험(Main) 블록 ---
    var main_procedure = {
        timeline: [create_slider_trial(main_stimuli)],
        timeline_variables: main_stimuli,
        randomize_order: true
    };
    timeline.push(main_procedure);

    // [중요] 5. DataPipe 저장 단계
    const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "9h8uHWnmjGTc", // ★ 사용자분의 DataPipe 실험 ID로 변경 필요 ★
        filename: filename,
        // [수정] OSF 저장 시 한글 깨짐 방지를 위해 BOM(\uFEFF) 문자 추가
        data_string: () => "\uFEFF" + jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    // --- Page 9: 종료 ---
    var end_experiment = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="question-box" style="text-align:center;">
                <h2>실험이 모두 종료되었습니다.</h2>
                <p>데이터가 안전하게 저장되었습니다.</p>
                <p>참여해 주셔서 대단히 감사합니다.</p>
                <p>이제 창을 닫으셔도 됩니다.</p>
            </div>
        `,
        choices: ['종료']
    };
    timeline.push(end_experiment);

    // 4. 실험 시작
    jsPsych.run(timeline);

</script>
</body>
</html>
